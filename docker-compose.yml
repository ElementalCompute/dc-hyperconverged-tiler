version: "3.8"

services:
  static-tiler:
    build: ./static-tiler
    container_name: static-tiler
    privileged: true
    ipc: host
    ports:
      - "6000:6000"
      - "4000:4000"
    networks:
      - tiler-network
    volumes:
      - ./static-tiler:/app
      - apphost1-shm:/dev/shm/apphost1
      - apphost2-shm:/dev/shm/apphost2
      - apphost3-shm:/dev/shm/apphost3
      - apphost4-shm:/dev/shm/apphost4
      - apphost5-shm:/dev/shm/apphost5
      - apphost6-shm:/dev/shm/apphost6
      - apphost7-shm:/dev/shm/apphost7
      - apphost8-shm:/dev/shm/apphost8
      - apphost9-shm:/dev/shm/apphost9
      - apphost10-shm:/dev/shm/apphost10
      - apphost11-shm:/dev/shm/apphost11
      - apphost12-shm:/dev/shm/apphost12
      - apphost13-shm:/dev/shm/apphost13
      - apphost14-shm:/dev/shm/apphost14
      - apphost15-shm:/dev/shm/apphost15
      - apphost16-shm:/dev/shm/apphost16

    # GPU configuration - use deploy block only (not runtime: nvidia)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, video, utility]

    environment:
      # GPU access - belt and suspenders approach
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility,video,graphics
      CUDA_VISIBLE_DEVICES: "0,1,2,3,4,5,6,7"
      CUDA_DEVICE_ORDER: PCI_BUS_ID

      # Prevent CUDA from caching compiled kernels (can cause issues with multiple GPUs)
      CUDA_CACHE_DISABLE: "1"

      # GStreamer plugin configuration
      GST_PLUGIN_PATH: /opt/nvidia/deepstream/deepstream/lib/gst-plugins
      GST_PLUGIN_SYSTEM_PATH: /opt/nvidia/deepstream/deepstream/lib/gst-plugins:/usr/lib/x86_64-linux-gnu/gstreamer-1.0

      # GStreamer debug level (set to 2+ for troubleshooting)
      GST_DEBUG: "0"

      # CRITICAL: Library paths for codec plugins
      LD_LIBRARY_PATH: /opt/nvidia/deepstream/deepstream/lib:/usr/local/lib/x86_64-linux-gnu:/usr/local/cuda/lib64

      # Python
      PYTHONUNBUFFERED: "1"

      # Legacy config
      PORT: 6000
      NUM_INPUTS: 16
      NUM_APPHOSTS: 16
      GRID_COLS: 4
      GRID_ROWS: 4

    restart: unless-stopped

  apphost:
    build: ./apphost
    container_name: apphost
    ipc: host
    ports:
      - "3000:3000"
    networks:
      - tiler-network
    environment:
      - DISPLAY=:99
      - PORT=3000
    volumes:
      - ./apphost:/app
    restart: unless-stopped

  controller:
    build: ./controller
    container_name: controller
    ports:
      - "5000:5000"
    networks:
      - tiler-network
    environment:
      - PORT=5000
    restart: unless-stopped

networks:
  tiler-network:
    driver: bridge

volumes:
  apphost1-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost2-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost3-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost4-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost5-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost6-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost7-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost8-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost9-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost10-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost11-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost12-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost13-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost14-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost15-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
  apphost16-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1g
